<!DOCTYPE html>
<html>
<head>
<!-- Python Endpoints: https://developers.google.com/appengine/docs/python/endpoints/ --> 
<!-- API Explorer: https://developers.google.com/apis-explorer/ -->
<script>

function lunchere_api_init() {
    var apisToLoad;
    var callback = function(msg) {
        console.log(msg + " loaded");
        if (--apisToLoad == 0) {
            signin(true, user_authed_no_retry);
        }
    }
    console.log("INIT");
    var ROOT = '/_ah/api';
    apisToLoad = 2;
    gapi.client.load('lunchere', 'dev', callback, ROOT);
    gapi.client.load('oauth', 'dev', callback, ROOT);
}

document.getElementById("logout").addEventListener("click", function() {
    gapi.auth.setToken(null);
});

function require_login(resp) {
    if (typeof(resp.error) !== "undefined" && resp.code == resp.error.code) {
	console.log("ERROR");
	console.log(resp);
	if (resp.code == 401) {
	    // ?? How to manually logout?
	    signin(false, user_authed_no_retry);
	}
	return false;
    }
    else {
	console.log("OK");
	console.log(resp);
	gapi.client.oauth.createLogoutURL({"url": "/" }).execute(function(resp) {
	    var logout_url = resp.url;
	});
	return true;
    }
}

function signin(mode, callback) {
    var CLIENT_ID = "@@CLIENT_ID@@";
    var SCOPES = "https://www.googleapis.com/auth/userinfo.email";
    gapi.auth.authorize({client_id: CLIENT_ID,
	    scope: SCOPES, immediate: mode,
	    response_type: 'token id_token'},
	    callback);
}

function user_authed_retry(token) {
    if (! user_authed_no_retry(token)) {
	signin(false, user_authed_no_retry);
    }
}

function user_authed_no_retry(token) {
    // Example of token
    //    access_token: "ya29.AHEi.................lrspejV4"
    //    client_id: "41839733.................usercontent.com"
    //    id_token: "eyJhbGci..........................2oFopTpT-nhtWLD8"
    if (token) {
	// This overwriting is well documented by 
	//         https://developers.google.com/appengine/docs/python/endpoints/consume_js#adding-oath-authentication
	token.access_token = token.id_token;
	gapi.auth.setToken(token);
	first_call(true);
	return true;
    }
    else {
	console.log("ERROR Cannot auth");
	first_call(false);
	return false;
    }
    // first_call();
}

function first_call(authed) {
    gapi.client.lunchere.test().execute(function(resp) {
	if (! require_login(resp))
	    return;
	second_call(authed);
    });
}

function second_call(authed) {
    var func;
    if (authed)
	func  = gapi.client.lunchere.today();
    else
	func  = gapi.client.lunchere.todayUnauth();
    func.execute(function(resp) {
	if (! require_login(resp))
	    return;
	document.getElementById("today").innerHTML = resp.name;
    });
}


</script>
<script src="https://apis.google.com/js/client.js?onload=lunchere_api_init">
</script>
</head>
<body>

<button id="logout">Log out</button>
<p>Today we go to: <span id="today">loading ...</span></p>
</body>
</html>
